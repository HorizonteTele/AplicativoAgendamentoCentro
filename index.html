<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendador PRO - Unidade Centro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Otimiza√ß√µes de Performance Visual */
        .status-select { 
            -webkit-appearance: none; -moz-appearance: none; appearance: none; 
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); 
            background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1.5em 1.5em; padding-right: 2.5rem; 
        }
        .status-updated { transition: background-color 0.5s; background-color: #dcfce7 !important; }
        
        /* Toasts R√°pidos */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { pointer-events: auto; min-width: 300px; padding: 16px 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; animation: slideIn 0.2s ease-out; background: white; border-left: 5px solid; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast-success { border-color: #10b981; } .toast-error { border-color: #ef4444; } 
        .toast-info { border-color: #3b82f6; } .toast-warning { border-color: #f59e0b; }
        
        /* Feedback Visual de Foco */
        input:focus, select:focus, textarea:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.025em; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 antialiased min-h-screen">

    <div class="toast-container" id="toast-container"></div>

    <div class="container mx-auto p-4 md:p-6 max-w-6xl">
        
        <!-- HEADER -->
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-extrabold text-slate-900 mb-1">üöÄ Agendador PRO</h1>
            <p class="text-slate-600 font-medium">Unidade Centro - Elite</p>
            <div class="mt-2 text-xs font-mono text-slate-400" id="live-clock">--:--:--</div>
        </header>

        <!-- TABS -->
        <div class="mb-6 bg-white p-1 rounded-xl shadow-sm border border-slate-200">
            <nav class="flex space-x-1">
                <button class="tab-btn flex-1 py-3 px-4 font-bold text-sm rounded-lg transition-all text-indigo-600 bg-indigo-50" data-tab="agendar">üìù Agendar</button>
                <button class="tab-btn flex-1 py-3 px-4 font-bold text-sm rounded-lg transition-all text-slate-600 hover:bg-slate-50" data-tab="gerenciar">üìä Gerenciar</button>
                <button class="tab-btn flex-1 py-3 px-4 font-bold text-sm rounded-lg transition-all text-slate-600 hover:bg-slate-50" data-tab="dashboard">üìà Metas</button>
            </nav>
        </div>

        <main id="content-area">
            
            <!-- SE√á√ÉO AGENDAR -->
            <section id="agendar-section" class="tab-content fade-in space-y-6">
                
                <!-- CONTROLES PRINCIPAIS -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">üë§ Quem √© voc√™?</label>
                        <select id="assistant-name" class="w-full p-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-semibold text-slate-800 focus:bg-white transition-colors">
                            <option value="">-- SELECIONE SEU NOME --</option>
                            <option value="ALANA">Alana</option>
                            <option value="GABRIELA">Gabriela</option>
                            <option value="NAIARA">Naiara</option>
                            <option value="NOEMY">Noemy</option>
                            <option value="RAIANE">Raiane</option>
                            <option value="SHEILA">Sheila</option>
                            <option value="THAIS">Thais</option>
                            <option value="TREINAMENTO">Treinamento</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">üìç Unidade</label>
                        <select id="location-select" class="w-full p-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-semibold text-slate-800 focus:bg-white transition-colors">
                            <option value="Centro" selected>Centro</option>
                            <option value="Eldorado">Eldorado</option>
                        </select>
                    </div>
                </div>

                <!-- ESTAT√çSTICAS R√ÅPIDAS -->
                <div class="grid grid-cols-4 gap-3">
                    <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 text-center">
                        <div class="text-2xl font-black text-slate-800" id="stat-total">0</div>
                        <div class="text-[10px] uppercase font-bold text-slate-400">Total</div>
                    </div>
                    <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 text-center">
                        <div class="text-2xl font-black text-green-600" id="stat-complete">0</div>
                        <div class="text-[10px] uppercase font-bold text-slate-400">Prontos</div>
                    </div>
                    <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 text-center">
                        <div class="text-2xl font-black text-amber-500" id="stat-puxadas">0</div>
                        <div class="text-[10px] uppercase font-bold text-slate-400">Puxadas</div>
                    </div>
                    <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 text-center">
                        <div class="text-2xl font-black text-indigo-600" id="stat-tomorrow">0</div>
                        <div class="text-[10px] uppercase font-bold text-slate-400">Amanh√£</div>
                    </div>
                </div>

                <!-- LISTA DE DESTINAT√ÅRIOS -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            üöÄ Fila de Envio
                        </h2>
                        <div class="flex gap-2 w-full sm:w-auto">
                            <button id="add-recipient-btn" class="flex-1 py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-md transition transform active:scale-95 text-sm">
                                + Amanh√£
                            </button>
                            <button id="add-puxada-btn" class="flex-1 py-2 px-4 bg-amber-500 hover:bg-amber-600 text-white font-bold rounded-lg shadow-md transition transform active:scale-95 text-sm">
                                + Puxada (Hoje)
                            </button>
                        </div>
                    </div>
                    <div id="recipients-list" class="space-y-4">
                        <div id="empty-state" class="text-center py-10 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50">
                            <p class="text-slate-400 font-medium">Lista vazia. Bora trabalhar?</p>
                        </div>
                    </div>
                </div>

                <!-- A√á√ïES -->
                <div class="flex flex-col sm:flex-row justify-end gap-3 pt-4 border-t border-slate-200">
                    <button id="quick-message-btn" class="py-3 px-6 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg transition transform hover:-translate-y-1">
                        üì® Msg R√°pida
                    </button>
                    <button id="generate-messages-btn" class="py-3 px-6 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transition transform hover:-translate-y-1 disabled:opacity-50 disabled:transform-none disabled:shadow-none" disabled>
                        üìù Gerar: Empresa
                    </button>
                    <button id="generate-instituto-btn" class="py-3 px-6 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl shadow-lg transition transform hover:-translate-y-1 disabled:opacity-50 disabled:transform-none disabled:shadow-none" disabled>
                        üè¢ Gerar: Instituto
                    </button>
                </div>

                <!-- MENSAGENS -->
                <div id="messages-section" class="hidden">
                    <div class="flex justify-between items-center mb-4 mt-8">
                        <h2 class="text-lg font-bold text-slate-800">Mensagens Prontas</h2>
                        <button id="clear-messages-btn" class="text-xs font-bold text-red-500 hover:text-red-700 uppercase tracking-wide">Limpar Tudo</button>
                    </div>
                    <div id="messages-list" class="space-y-4"></div>
                </div>
            </section>
            
            <!-- SE√á√ÉO GERENCIAR -->
            <section id="gerenciar-section" class="tab-content hidden fade-in">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="text-lg font-bold text-slate-800">Agendamentos do Dia</h2>
                        <button id="refresh-appointments-btn" class="py-2 px-4 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-lg transition text-sm flex items-center gap-2">
                            üîÑ Atualizar
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
                        <input type="text" id="filter-search" placeholder="Buscar nome..." class="p-2 border-2 border-slate-200 rounded-lg text-sm font-medium">
                        <select id="filter-status" class="p-2 border-2 border-slate-200 rounded-lg text-sm font-medium">
                            <option value="">Todos os Status</option>
                            <option value="CONFIRMADA">‚úÖ Confirmada</option>
                            <option value="CANCELADA">‚ùå Cancelada</option>
                            <option value="PUXADA">‚ö° Puxada</option>
                            <option value="">‚è≥ Pendente</option>
                        </select>
                        <div class="flex items-center gap-2 px-2">
                            <input type="checkbox" id="auto-refresh-toggle" class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500">
                            <label for="auto-refresh-toggle" class="text-sm font-semibold text-slate-600">Auto-refresh</label>
                        </div>
                    </div>
                    
                    <div id="management-list" class="space-y-3 min-h-[200px]">
                        <div id="loader" class="text-center py-10 hidden">
                            <div class="loader mx-auto border-4 border-indigo-200 border-t-indigo-600 rounded-full w-10 h-10 animate-spin"></div>
                        </div>
                        <div id="management-empty-state" class="text-center py-10">
                            <p class="text-slate-400 font-medium">Nada encontrado aqui.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SE√á√ÉO DASHBOARD -->
            <section id="dashboard-section" class="tab-content hidden fade-in">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-bold text-slate-800 mb-6">Performance Di√°ria</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="h-64 flex items-center justify-center">
                            <canvas id="statusChart"></canvas>
                        </div>
                        <div id="dashboard-stats" class="space-y-4"></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- MODAL MENSAGEM R√ÅPIDA -->
    <div id="quick-message-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 animate-[fadeIn_0.2s_ease-out]">
            <h3 class="text-xl font-black text-slate-800 mb-4">‚ö° Msg R√°pida</h3>
            <div class="space-y-4">
                <input type="text" id="quick-jovem" class="w-full p-3 border-2 border-slate-200 rounded-xl font-medium" placeholder="Nome do Jovem">
                <input type="tel" id="quick-numero" class="w-full p-3 border-2 border-slate-200 rounded-xl font-medium phone-mask" placeholder="WhatsApp (com DDD)" maxlength="15">
                
                <div class="space-y-2">
                    <label class="flex items-center p-3 border-2 border-slate-100 rounded-xl cursor-pointer hover:border-indigo-200 hover:bg-indigo-50 transition">
                        <input type="radio" name="quick-template" value="variacao1" class="w-4 h-4 text-indigo-600" checked>
                        <span class="ml-3 text-sm font-bold text-slate-700">Retorno at√© amanh√£</span>
                    </label>
                    <label class="flex items-center p-3 border-2 border-slate-100 rounded-xl cursor-pointer hover:border-indigo-200 hover:bg-indigo-50 transition">
                        <input type="radio" name="quick-template" value="variacao2" class="w-4 h-4 text-indigo-600">
                        <span class="ml-3 text-sm font-bold text-slate-700">Retorno OBRIGAT√ìRIO</span>
                    </label>
                    <label class="flex items-center p-3 border-2 border-red-100 rounded-xl cursor-pointer hover:border-red-200 hover:bg-red-50 transition">
                        <input type="radio" name="quick-template" value="followup" class="w-4 h-4 text-red-600">
                        <span class="ml-3 text-sm font-bold text-red-700">FOLLOW-UP (Urgente)</span>
                    </label>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button id="quick-modal-cancel" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition">Cancelar</button>
                <button id="quick-generate-btn" class="flex-1 py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition">Gerar e Enviar</button>
            </div>
            <div id="quick-message-result" class="mt-4 hidden"></div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURA√á√ÉO BLINDADA ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyjKPgtDS1mRK0aNsbGEjv1m93JCmcaHqqfHoE6b3aIJCJ4T52X0VUDa7ztuUnq_1pG/exec';

        // --- SISTEMA DE TOAST (NOTIFICA√á√ïES R√ÅPIDAS) ---
        const showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = { success: 'toast-success', error: 'toast-error', info: 'toast-info', warning: 'toast-warning' };
            const icons = { success: '‚úÖ', error: '‚ùå', info: '‚ÑπÔ∏è', warning: '‚ö†Ô∏è' };
            
            toast.className = `toast ${colors[type]}`;
            toast.innerHTML = `<span class="text-xl">${icons[type]}</span><span class="font-bold text-sm text-slate-700">${message}</span>`;
            
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 200) }, 3000);
        };

        // --- REL√ìGIO EM TEMPO REAL ---
        setInterval(() => {
            document.getElementById('live-clock').textContent = new Date().toLocaleTimeString('pt-BR');
        }, 1000);

        // --- ELEMENTOS ---
        const els = {
            assistant: document.getElementById('assistant-name'),
            location: document.getElementById('location-select'),
            list: document.getElementById('recipients-list'),
            msgSection: document.getElementById('messages-section'),
            msgList: document.getElementById('messages-list'),
            mgmtList: document.getElementById('management-list'),
            loader: document.getElementById('loader'),
            emptyState: document.getElementById('empty-state'),
            mgmtEmpty: document.getElementById('management-empty-state'),
            filterSearch: document.getElementById('filter-search'),
            filterStatus: document.getElementById('filter-status'),
            stats: {
                total: document.getElementById('stat-total'),
                complete: document.getElementById('stat-complete'),
                puxadas: document.getElementById('stat-puxadas'),
                tomorrow: document.getElementById('stat-tomorrow')
            }
        };

        let recipients = [];
        let allAppointments = [];
        let autoRefreshInterval = null;
        const LOCAL_STORAGE_KEY = 'agendadorProCentro_V1'; // Chave nova pra n√£o misturar
        let statusChartInstance = null;

        // --- M√ÅSCARAS DE IDENTIDADE (O SEGREDO) ---
        const assistantFullNameMap = {
            'ALANA': 'Amanda Vasconcelos', // MASK
            'GABRIELA': 'Sophia Bittencourt', // MASK
            'NAIARA': 'Naiara Mendes',
            'NOEMY': 'Noemy Rocha',
            'RAIANE': 'Raiane Campos',
            'SHEILA': 'Cristina Albuquerque', // MASK
            'THAIS': 'Thais Oliveira',
            'TREINAMENTO': 'Coordena√ß√£o'
        };

        // --- NAVEGA√á√ÉO ---
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Reset visual
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('text-indigo-600', 'bg-indigo-50');
                    b.classList.add('text-slate-600');
                });
                // Activate current
                btn.classList.remove('text-slate-600');
                btn.classList.add('text-indigo-600', 'bg-indigo-50');
                
                // Content Switch
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`${btn.dataset.tab}-section`).classList.remove('hidden');

                if (btn.dataset.tab === 'gerenciar') fetchAppointments();
                if (btn.dataset.tab === 'dashboard') fetchDashboardData();
            });
        });

        // --- L√ìGICA DE DATA ---
        const getDates = () => {
            const today = new Date();
            const tomorrow = new Date(today);
            // L√≥gica S√°bado -> Segunda
            if (today.getDay() === 6) tomorrow.setDate(today.getDate() + 2);
            else tomorrow.setDate(today.getDate() + 1);
            
            const fmt = d => `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
            return { today: fmt(today), tomorrow: fmt(tomorrow) };
        };

        // --- C√ìDIGO DO JOVEM (HASH R√ÅPIDO) ---
        const generateCode = (name) => {
            const initials = name.split(' ').slice(0, 3).map(w => w[0]?.toUpperCase()).join('') || 'XYZ';
            return initials + Math.floor(100 + Math.random() * 900);
        };

        // --- PERSIST√äNCIA (SALVA TUDO LOCAL) ---
        const saveData = () => {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({ timestamp: Date.now(), recipients }));
            updateStats();
            updateButtons();
        };

        const loadData = () => {
            const data = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '{}');
            if (data.recipients && (Date.now() - data.timestamp < 86400000)) {
                recipients = data.recipients;
                renderList();
            }
        };

        // --- ESTAT√çSTICAS ---
        const updateStats = () => {
            els.stats.total.textContent = recipients.length;
            els.stats.complete.textContent = recipients.filter(r => r.jovem && r.responsavel && r.data && r.horario && r.numero_responsavel).length;
            els.stats.puxadas.textContent = recipients.filter(r => r.isPuxada).length;
            els.stats.tomorrow.textContent = recipients.filter(r => !r.isPuxada).length;
        };

        // --- RENDERIZA√á√ÉO DA LISTA ---
        const renderList = () => {
            els.list.innerHTML = '';
            if (recipients.length === 0) {
                els.emptyState.style.display = 'block';
                els.list.appendChild(els.emptyState);
            } else {
                els.emptyState.style.display = 'none';
                recipients.forEach((r, i) => els.list.appendChild(createItem(r, i)));
            }
            updateButtons();
            updateStats();
        };

        const createItem = (r, i) => {
            const div = document.createElement('div');
            div.className = `p-4 border-2 ${r.isPuxada ? 'border-amber-200 bg-amber-50' : 'border-indigo-100 bg-white'} rounded-xl space-y-3 shadow-sm hover:shadow-md transition-all`;
            div.dataset.id = r.id;
            
            div.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-slate-400 text-xs">#${i+1}</span>
                        ${r.isPuxada ? '<span class="badge bg-amber-500 text-white">‚ö° PUXADA</span>' : '<span class="badge bg-indigo-600 text-white">üìÖ AMANH√É</span>'}
                    </div>
                    <button class="rm-btn text-slate-400 hover:text-red-500 p-1" title="Excluir">‚úï</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <input type="text" placeholder="Nome do Jovem *" data-f="jovem" value="${r.jovem}" class="p-2 border rounded-lg text-sm font-semibold focus:border-indigo-500 w-full">
                    <input type="text" placeholder="Nome Respons√°vel *" data-f="responsavel" value="${r.responsavel}" class="p-2 border rounded-lg text-sm focus:border-indigo-500 w-full">
                    <input type="tel" placeholder="Tel Respons√°vel (55...)" data-f="numero_responsavel" value="${r.numero_responsavel}" class="p-2 border rounded-lg text-sm phone-mask focus:border-indigo-500 w-full">
                    <div class="flex gap-2">
                        <input type="text" placeholder="Data" data-f="data" value="${r.data}" class="p-2 border rounded-lg text-sm w-1/2 date-mask text-center font-mono">
                        <input type="text" placeholder="Hora" data-f="horario" value="${r.horario}" class="p-2 border rounded-lg text-sm w-1/2 time-mask text-center font-mono">
                    </div>
                    <input type="tel" placeholder="Tel Jovem (Opcional)" data-f="numero_jovem" value="${r.numero_jovem}" class="p-2 border rounded-lg text-sm phone-mask">
                    <input type="text" placeholder="Data Nasc (DD/MM/AAAA)" data-f="data_nascimento" value="${r.data_nascimento}" class="p-2 border rounded-lg text-sm date-mask">
                </div>
            `;
            
            // Event Delegation Otimizado no item
            div.querySelector('.rm-btn').onclick = () => {
                if(confirm('Apagar?')) { recipients = recipients.filter(x => x.id !== r.id); saveData(); renderList(); }
            };
            
            div.querySelectorAll('input').forEach(input => {
                input.oninput = (e) => {
                    r[e.target.dataset.f] = e.target.value;
                    
                    // M√°scaras instant√¢neas
                    if(e.target.classList.contains('phone-mask')) e.target.value = e.target.value.replace(/\D/g,'').replace(/^(\d{2})/, '55$1').slice(0,13);
                    if(e.target.classList.contains('date-mask')) e.target.value = e.target.value.replace(/\D/g,'').replace(/(\d{2})(\d)/,'$1/$2').replace(/(\d{2})(\d)/,'$1/$2').slice(0,10);
                    if(e.target.classList.contains('time-mask')) e.target.value = e.target.value.replace(/\D/g,'').replace(/(\d{2})(\d)/,'$1:$2').slice(0,5);
                    
                    saveData();
                };
            });
            
            return div;
        };

        // --- A√á√ïES DE LISTA ---
        document.getElementById('add-recipient-btn').onclick = () => {
            recipients.push({ id: Date.now().toString(), jovem: '', responsavel: '', data: getDates().tomorrow, horario: '', numero_responsavel: '', numero_jovem: '', data_nascimento: '', isPuxada: false });
            renderList(); saveData();
        };
        document.getElementById('add-puxada-btn').onclick = () => {
            recipients.push({ id: Date.now().toString(), jovem: '', responsavel: '', data: getDates().today, horario: '', numero_responsavel: '', numero_jovem: '', data_nascimento: '', isPuxada: true });
            renderList(); saveData();
        };

        const updateButtons = () => {
            const ok = els.assistant.value && recipients.length > 0;
            document.getElementById('generate-messages-btn').disabled = !ok;
            document.getElementById('generate-instituto-btn').disabled = !ok;
        };
        els.assistant.onchange = updateButtons;

        // --- GERA√á√ÉO DE MENSAGENS (CORE LOGIC) ---
        const templates = {
            base: `*CONVOCA√á√ÉO PARA TESTE VOCACIONAL E CADASTRAMENTO GRATUITO AO MERCADO DE TRABALHO*

*Jovem Convocado:* {jovem} {idade}
*Respons√°vel:* {responsavel}
{irmaos}

---
*Dados do Agendamento:*

*Data:* {diaSemana}, {data}
*Hor√°rio:* {horario} (chegar 10min antes)

{local}

*Documentos Necess√°rios:*

‚Ä¢ RG, CPF ou Certid√£o de Nascimento do jovem.
‚Ä¢ Comprovante de Resid√™ncia.

---
*C√≥digo do Jovem:* {codigo}

*Aten√ß√£o:* A presen√ßa do respons√°vel junto com o jovem √© indispens√°vel. O c√≥digo j√° foi gerado e a aus√™ncia pode ser interpretada como falta de comprometimento, bloqueando futuras oportunidades pelo projeto social.

Atenciosamente,

*{assistente}*
{org}`
        };

        const locations = {
            Centro: `*Local:* Rua Curitiba, 656, 11¬∞ andar - Centro, Belo Horizonte.\n\n(Em frente a Casa&Video, pr√≥ximo a Marisa)`,
            Eldorado: `*Local:* Avenida Jo√£o C√©sar de Oliveira, N¬∫ 953, 2¬∫ andar ‚Äì Eldorado, Contagem.`
        };

        const generate = (isInstituto) => {
            const msgs = [];
            const assistant = els.assistant.value;
            const alias = assistantFullNameMap[assistant] || assistant;
            const loc = els.location.value;

            recipients.forEach(r => {
                if(!r.jovem || !r.responsavel || !r.data || !r.horario || !r.numero_responsavel) return;
                
                // Idade Calc
                let idadeStr = "";
                if(r.data_nascimento) {
                    const [d,m,y] = r.data_nascimento.split('/');
                    const age = new Date().getFullYear() - y - ((new Date().getMonth() - (m-1) < 0 || (new Date().getMonth() == (m-1) && new Date().getDate() < d)) ? 1 : 0);
                    idadeStr = `(${age} anos)`;
                }

                // Dia da Semana
                const [dd,mm,aaaa] = r.data.split('/');
                const diaSemana = new Date(aaaa, mm-1, dd).toLocaleDateString('pt-BR', {weekday:'long'}).toUpperCase();

                let txt = templates.base
                    .replace('{jovem}', r.jovem)
                    .replace('{idade}', idadeStr)
                    .replace('{responsavel}', r.responsavel)
                    .replace('{irmaos}', r.irmaos ? `*Irm√£os:* ${r.irmaos}` : '')
                    .replace('{diaSemana}', diaSemana)
                    .replace('{data}', r.data)
                    .replace('{horario}', r.horario)
                    .replace('{local}', locations[loc])
                    .replace('{codigo}', generateCode(r.jovem))
                    .replace('{assistente}', alias)
                    .replace('{org}', isInstituto ? "Instituto Crescer'Minas" : "Coordena√ß√£o | Empresa Crescer");

                msgs.push({ txt, tel: r.numero_responsavel, raw: { ...r, assistente: assistant, local: loc, codigo: generateCode(r.jovem), isInstituto } });
            });

            if(msgs.length === 0) return showToast('Preencha os dados obrigat√≥rios!', 'warning');
            
            renderMsgs(msgs);
            els.msgSection.classList.remove('hidden');
            els.msgSection.scrollIntoView({behavior:'smooth'});
            showToast(`${msgs.length} mensagens geradas!`, 'success');
        };

        const renderMsgs = (list) => {
            els.msgList.innerHTML = '';
            list.forEach(m => {
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-xl border-2 border-slate-100 shadow-sm';
                div.innerHTML = `
                    <div class="flex justify-between text-sm font-bold text-slate-500 mb-2">
                        <span>Para: ${m.raw.jovem}</span>
                        <span>${m.txt.length} caracteres</span>
                    </div>
                    <textarea readonly class="w-full h-32 p-3 bg-slate-50 rounded-lg text-xs font-mono mb-3 border focus:border-indigo-500">${m.txt}</textarea>
                    <div class="flex gap-2">
                        <a href="https://wa.me/${m.tel}?text=${encodeURIComponent(m.txt)}" target="_blank" class="flex-1 py-2 bg-green-500 text-white font-bold rounded-lg text-center hover:bg-green-600 transition flex items-center justify-center gap-2">
                            üì± WhatsApp
                        </a>
                        <button class="save-btn flex-1 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition" data-json='${JSON.stringify(m.raw)}'>
                            üíæ Salvar
                        </button>
                    </div>
                `;
                els.msgList.appendChild(div);
            });
        };

        document.getElementById('generate-messages-btn').onclick = () => generate(false);
        document.getElementById('generate-instituto-btn').onclick = () => generate(true);

        document.getElementById('messages-list').addEventListener('click', async (e) => {
            if(e.target.classList.contains('save-btn')) {
                const btn = e.target;
                const data = JSON.parse(btn.dataset.json);
                const now = new Date();
                data.horario_lancamento = `${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()} ${now.getHours()}:${now.getMinutes()}`;

                btn.disabled = true;
                btn.innerHTML = '‚è≥ ...';
                
                try {
                    await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
                    btn.innerHTML = '‚úÖ Salvo';
                    btn.classList.replace('bg-blue-600', 'bg-green-600');
                    showToast('Agendamento salvo!', 'success');
                    
                    // Auto-flag as saved in local list
                    const found = recipients.find(r => r.jovem === data.jovem);
                    if(found) { found.saved = true; saveData(); }
                } catch(err) {
                    btn.innerHTML = '‚ùå Erro';
                    btn.classList.replace('bg-blue-600', 'bg-red-600');
                    showToast('Erro ao salvar. Verifique conex√£o.', 'error');
                    btn.disabled = false;
                }
            }
        });

        document.getElementById('clear-messages-btn').onclick = () => {
            els.msgSection.classList.add('hidden');
            els.msgList.innerHTML = '';
        };

        // --- GERENCIAMENTO (FETCH & RENDER) ---
        const fetchAppointments = async () => {
            const assistant = els.assistant.value;
            if(!assistant) { els.mgmtList.innerHTML = '<div class="text-center py-8 text-slate-500">Selecione seu nome primeiro.</div>'; return; }

            els.loader.style.display = 'block'; els.mgmtEmpty.style.display = 'none'; els.mgmtList.innerHTML = ''; els.mgmtList.appendChild(els.loader);

            const today = new Date();
            const dateStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            
            try {
                const res = await fetch(`${SCRIPT_URL}?action=getAppointments&assistant=${assistant}&date=${dateStr}`);
                const json = await res.json();
                if(json.status === 'success') {
                    allAppointments = json.data;
                    renderMgmt(allAppointments);
                }
            } catch(e) { showToast('Erro ao buscar agenda.', 'error'); } 
            finally { els.loader.style.display = 'none'; }
        };

        const renderMgmt = (list) => {
            els.mgmtList.innerHTML = '';
            if(list.length === 0) { els.mgmtList.appendChild(els.mgmtEmpty); els.mgmtEmpty.style.display = 'block'; return; }
            
            list.sort((a,b) => a.horario.localeCompare(b.horario));
            
            list.forEach(a => {
                const div = document.createElement('div');
                const colors = { 'CONFIRMADA': 'border-green-300 bg-green-50', 'CANCELADA': 'border-red-300 bg-red-50', 'PUXADA': 'border-amber-300 bg-amber-50' };
                div.className = `p-4 border-2 rounded-xl transition-all ${colors[a.situacao] || 'border-slate-200 bg-white'}`;
                
                div.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between gap-3">
                        <div>
                            <div class="font-black text-slate-800 text-lg">${a.jovem}</div>
                            <div class="text-xs font-bold text-slate-500 uppercase">${a.responsavel}</div>
                            <div class="flex gap-3 mt-2 text-sm font-mono text-slate-600">
                                <span>üìû <a href="tel:${a.telefone_resp}" class="hover:text-indigo-600">${a.telefone_resp}</a></span>
                                <span>‚è∞ ${a.horario}</span>
                            </div>
                        </div>
                        <select class="status-select p-2 border-2 border-slate-200 rounded-lg text-sm font-bold bg-white focus:border-indigo-500 h-10 self-start sm:self-center" data-row="${a.rowId}" data-sheet="${a.sheetName}">
                            <option value="">PENDENTE</option>
                            ${['PUXADA','SI SEM INTERESSE','CONFIRMADA','CANCELADA','REAGENDAR','J√Å VEIO','MATRICULA','CONFIRMOU E N√ÉO VEIO'].map(s => `<option value="${s}" ${a.situacao===s?'selected':''}>${s}</option>`).join('')}
                        </select>
                    </div>
                `;
                els.mgmtList.appendChild(div);
            });
        };

        // Event Delegation para Status Change (Performance)
        els.mgmtList.onchange = async (e) => {
            if(e.target.classList.contains('status-select')) {
                const sel = e.target;
                const prev = sel.style.backgroundColor;
                sel.disabled = true; sel.style.backgroundColor = '#fef3c7'; // Amarelo carregando
                
                try {
                    await fetch(SCRIPT_URL, {
                        method: 'POST', mode: 'no-cors',
                        body: JSON.stringify({ action: 'updateStatus', rowId: sel.dataset.row, sheetName: sel.dataset.sheet, newStatus: sel.value })
                    });
                    sel.style.backgroundColor = '#dcfce7'; // Verde sucesso
                    showToast('Status atualizado!', 'success');
                    setTimeout(() => fetchAppointments(), 1000); // Refresh silencioso
                } catch(err) {
                    sel.style.backgroundColor = '#fee2e2'; // Vermelho erro
                    showToast('Erro ao atualizar.', 'error');
                } finally { sel.disabled = false; }
            }
        };

        // Filtros R√°pidos
        const applyFilter = () => {
            const txt = els.filterSearch.value.toLowerCase();
            const sts = els.filterStatus.value;
            const filtered = allAppointments.filter(a => 
                (a.jovem.toLowerCase().includes(txt) || a.responsavel.toLowerCase().includes(txt)) &&
                (sts === '' || a.situacao === sts)
            );
            renderMgmt(filtered);
        };
        els.filterSearch.oninput = applyFilter;
        els.filterStatus.onchange = applyFilter;

        document.getElementById('refresh-appointments-btn').onclick = fetchAppointments;
        document.getElementById('auto-refresh-toggle').onchange = (e) => {
            if(e.target.checked) {
                autoRefreshInterval = setInterval(() => { if(!document.getElementById('gerenciar-section').classList.contains('hidden')) fetchAppointments(); }, 30000);
                showToast('Auto-refresh LIGADO', 'info');
            } else { clearInterval(autoRefreshInterval); showToast('Auto-refresh DESLIGADO', 'info'); }
        };

        // --- DASHBOARD (SIMPLIFICADO) ---
        const fetchDashboardData = async () => {
            await fetchAppointments(); // Reutiliza l√≥gica
            if(allAppointments.length === 0) return;
            
            // Stats
            const counts = { CONFIRMADA:0, CANCELADA:0, PUXADA:0, PENDENTE:0, TOTAL: allAppointments.length };
            allAppointments.forEach(a => {
                if(a.situacao === 'CONFIRMADA' || a.situacao === 'J√Å VEIO') counts.CONFIRMADA++;
                else if(a.situacao === 'CANCELADA' || a.situacao === 'SI SEM INTERESSE') counts.CANCELADA++;
                else if(a.situacao === 'PUXADA') counts.PUXADA++;
                else counts.PENDENTE++;
            });

            document.getElementById('dashboard-stats').innerHTML = `
                <div class="p-4 bg-green-50 rounded-xl border border-green-200"><div class="text-2xl font-black text-green-600">${counts.CONFIRMADA}</div><div class="text-xs font-bold text-green-800 uppercase">Confirmados</div></div>
                <div class="p-4 bg-red-50 rounded-xl border border-red-200"><div class="text-2xl font-black text-red-600">${counts.CANCELADA}</div><div class="text-xs font-bold text-red-800 uppercase">Perdidos</div></div>
                <div class="p-4 bg-slate-50 rounded-xl border border-slate-200"><div class="text-2xl font-black text-slate-600">${counts.PENDENTE}</div><div class="text-xs font-bold text-slate-800 uppercase">Pendentes</div></div>
            `;

            const ctx = document.getElementById('statusChart');
            if(statusChartInstance) statusChartInstance.destroy();
            statusChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Confirmados', 'Perdidos', 'Pendentes'],
                    datasets: [{ data: [counts.CONFIRMADA, counts.CANCELADA, counts.PENDENTE], backgroundColor: ['#10b981', '#ef4444', '#cbd5e1'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });
        };

        // --- MENSAGEM R√ÅPIDA (MODAL) ---
        const modal = document.getElementById('quick-message-modal');
        document.getElementById('quick-message-btn').onclick = () => { modal.classList.remove('hidden'); modal.classList.add('flex'); };
        document.getElementById('quick-modal-cancel').onclick = () => { modal.classList.add('hidden'); modal.classList.remove('flex'); };
        
        document.getElementById('quick-generate-btn').onclick = () => {
            const nome = document.getElementById('quick-jovem').value;
            const num = document.getElementById('quick-numero').value.replace(/\D/g, '');
            const type = document.querySelector('input[name="quick-template"]:checked').value;
            
            if(!nome || num.length < 10) return showToast('Preencha nome e n√∫mero v√°lido', 'error');
            
            const msgs = {
                variacao1: `CRESCER | Depto Orienta√ß√£o\n\nRef.: ${nome}\n\nCadastro liberado para:\nüìå Teste Vocacional\nüìå Base Curricular Regional\n\nAgendamento: Retornar esta liga√ß√£o\nHor√°rio: 9h √†s 17h\n\n‚ö†Ô∏è Prazo: At√© amanh√£\n\nAtt, Equipe de Cadastramento`,
                variacao2: `CRESCER | URGENTE\n\nRef.: ${nome}\n\nLiberado: Teste Vocacional + Cadastramento.\n\nüîî RETORNO OBRIGAT√ìRIO\nLigue para este n√∫mero agora para agendar.\n\nN√£o responda por texto.\nPrazo final: AMANH√É.`,
                followup: `‚ö†Ô∏è Lembrete Final - ${nome}\n\nPrazo encerra HOJE √†s 17h.\n\nRetorne a liga√ß√£o imediatamente para n√£o perder o cadastro.\n\n√öltima chamada.`
            };
            
            const link = `https://wa.me/55${num}?text=${encodeURIComponent(msgs[type])}`;
            window.open(link, '_blank');
            showToast('Enviando para WhatsApp...', 'success');
            modal.classList.add('hidden'); modal.classList.remove('flex');
        };

        // INICIALIZA
        loadData();
    });
    </script>
</body>
</html>